#!/bin/bash

# Создание скриптов для анализа log-файла “access-4560-644067.log”.

#======================================================

# Действие 1. Получить список IP адресов (Top 10 с наибольшим кол-вом запросов) с указанием кол-ва запросов.

#Путь к файлу логов и выходному файлу
LOG_FILE="/home/badger/access-4560-644067.log"
OUTPUT_FILE="/home/badger/loganalysis"

#Проверяем, существует ли файл логов
if [ ! -f "$LOG_FILE" ]; then
    echo "Ошибка: файл $LOG_FILE не найден!" >&2
    exit 1
fi

#Анализируем логи и сохраняем топ-10 IP в файл loganalysis
echo "Топ-10 IP-адресов с наибольшим количеством запросов:" > "$OUTPUT_FILE"
echo "-----------------------------------------------" >> "$OUTPUT_FILE"
awk '{print $1}' "$LOG_FILE" | sort | uniq -c | sort -nr | head -n 10 >> "$OUTPUT_FILE"

echo "Действие 1 выполнено. Результаты сохранены в файл $OUTPUT_FILE"

#=======================================================

#Действие 2. Получить список запрашиваемых URL (с наибольшим кол-вом запросов) с указанием кол-ва запросов.

# Анализируем лог и получаем топ-10 URL
echo "Топ-10 самых запрашиваемых URL:" >> "$OUTPUT_FILE"
echo "-----------------------------------------------" >> "$OUTPUT_FILE"
awk '{print $7}' "$LOG_FILE" | sort | uniq -c | sort -nr | head -n 10 >> "$OUTPUT_FILE"

echo "Действие 2 выполнено. Результаты сохранены в файл $OUTPUT_FILE"

#=======================================================

# Действие 3. Вывести ошибки веб-сервера/приложения.

#Анализируем ошибки (HTTP-статусы 4xx и 5xx)
echo "Список ошибок сервера/приложения (4xx и 5xx):" >> "$OUTPUT_FILE"
echo "-----------------------------------------------" >> "$OUTPUT_FILE"
awk '$9 ~ /^[45][0-9]{2}$/ {print $9, $7}' "$LOG_FILE" | sort | uniq -c | sort -nr >> "$OUTPUT_FILE"

echo "Действие 3 выполнено. Результаты сохранены в файл $OUTPUT_FILE"

#=======================================================

# Действие 4. Вывести список всех кодов HTTP ответа с указанием их кол-ва.


# Извлекаем коды HTTP ответов, подсчитываем их и сохраняем в выходной файл.
echo "Коды HTTP ответов и их количество" >> "$OUTPUT_FILE"
echo "-----------------------------------------------" >> "$OUTPUT_FILE"
awk '{print $9}' "$LOG_FILE" | grep -E "^[0-9]{3}$" | sort | uniq -c | sort -nr >> "$OUTPUT_FILE"

echo "Действие 4 выполнено. Результаты сохранены в файл $OUTPUT_FILE"

#========================================================

# Действие 5. Отправка содержимого файла loganalysis в теле письма email.

